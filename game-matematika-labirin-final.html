<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Matematika Labirin</title>
  <style>
    :root{
      --bg:#f5f7ff; --card:#fff; --ink:#0f172a; --muted:#475569;
      --line:#e2e8f0; --accent:#2563eb; --soft:#eef2ff;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{ margin:0; background:var(--bg); color:var(--ink); }
    .wrap{ max-width:980px; margin:0 auto; padding:16px; }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:16px;
      padding:14px; box-shadow:0 6px 18px rgba(15,23,42,.06); margin-bottom:12px;
    }
    h1{ margin:0 0 6px; font-size:22px; }
    .muted{ margin:0; color:var(--muted); font-size:14px; }
    .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px; }
    input{
      padding:12px; border-radius:12px; border:1px solid var(--line);
      font-size:16px; min-width:220px; outline:none;
    }
    button{
      padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      background:var(--accent); color:#fff; font-weight:800; font-size:16px; cursor:pointer;
    }
    button.secondary{ background:#fff; color:var(--ink); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .hud{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:10px; }
    .box{ background:var(--soft); border:1px solid #dbeafe; border-radius:14px; padding:12px; }
    .box b{ font-size:18px; }

    .gameArea{
      display:grid; grid-template-columns: 1fr 280px; gap:12px; align-items:start;
    }
    @media (max-width: 920px){
      .gameArea{ grid-template-columns: 1fr; }
    }

    canvas{
      width:100%; height:auto; aspect-ratio: 16 / 10;
      background:#ffffff; border:1px solid var(--line); border-radius:16px;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,.02);
      touch-action: none;
    }

    .panel{
      background:#fff; border:1px solid var(--line); border-radius:16px; padding:12px;
    }
    .panel h2{ margin:0 0 6px; font-size:16px; }
    .panel ul{ margin:8px 0 0; padding-left:18px; color:var(--muted); }
    .result{
      margin-top:10px; border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff;
    }
    .result .big{ font-size:26px; font-weight:900; margin-top:4px; }
    .small{ color:var(--muted); font-size:13px; margin-top:4px; }

    /* D-Pad */
    .dpadHint{
      position: fixed; left: 14px; bottom: 196px; z-index: 10;
      font-size: 12px; color: var(--muted);
      background: rgba(255,255,255,.85);
      border: 1px solid var(--line);
      padding: 6px 10px; border-radius: 999px;
      display:none;
    }
    .dpadWrap{
      position: fixed;
      left: 14px;
      bottom: 14px;
      width: 170px;
      height: 170px;
      z-index: 10;
      display: none;
      user-select: none;
      -webkit-user-select:none;
      touch-action: none;
    }
    @media (max-width: 920px){
      .dpadWrap{ display:block; }
      .dpadHint{ display:block; }
    }
    .dpad{
      width: 170px; height: 170px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 10px;
      align-items: center;
      justify-items: center;
      padding: 10px;
      border-radius: 18px;
      background: rgba(37,99,235,.08);
      border: 2px solid rgba(37,99,235,.18);
      backdrop-filter: blur(2px);
      box-shadow: 0 12px 28px rgba(15,23,42,.12);
    }
    .dirBtn{
      width: 52px; height: 52px;
      border-radius: 14px;
      border: 1px solid rgba(37,99,235,.25);
      background: rgba(255,255,255,.9);
      font-size: 20px;
      font-weight: 900;
      color: var(--ink);
      display:flex; align-items:center; justify-content:center;
      cursor: pointer;
      touch-action: none;
    }
    .dirBtn:active, .dirBtn.active{
      background: rgba(37,99,235,.18);
      border-color: rgba(37,99,235,.45);
      transform: translateY(1px);
    }
    .spacer{ width:52px; height:52px; }

    /* Modal soal */
    .modalOverlay{
      position:fixed; inset:0; background: rgba(15,23,42,.35);
      display:none; align-items:center; justify-content:center; padding:16px; z-index: 20;
    }
    .modal{
      width:min(820px, 100%); background:#fff; border:1px solid var(--line);
      border-radius:16px; padding:16px; box-shadow:0 20px 50px rgba(15,23,42,.18);
    }
    .qTitle{ margin:0; font-size:18px; line-height:1.35; white-space:pre-wrap; }
    .qMeta{ margin:8px 0 0; font-size:13px; color:var(--muted); }
    .choices{ display:grid; gap:10px; margin-top:14px; }
    .choiceBtn{
      text-align:left; background:#fff; color:var(--ink);
      border:1px solid var(--line); padding:14px; border-radius:14px;
      font-size:16px; font-weight:800; cursor:pointer;
    }
    .choiceBtn:hover{ background:#f8fafc; }
    .choiceBtn:disabled{ opacity:.75; cursor:not-allowed; }
    .feedback{
      margin-top:12px; padding:12px; border-radius:14px; border:1px solid var(--line);
      background:#f8fafc; color:var(--muted); display:none; font-size:15px;
    }
    .feedback.ok{ border-color:#bbf7d0; background:#f0fdf4; }
    .feedback.bad{ border-color:#fecaca; background:#fff1f2; }
    .footerBtns{ display:flex; justify-content:flex-end; margin-top:12px; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Game Matematika Labirin</h1>
      <p class="muted">Gerakkan karakter di labirin. Ada 10 pintu—setiap pintu harus jawab soal. Salah tidak kena penalti, tapi pintu tetap terkunci.</p>

      <div class="controls">
        <input id="playerName" placeholder="Tulis namamu..." maxlength="20" />
        <button id="btnStart">Mulai</button>
        <button id="btnReset" class="secondary" disabled>Ulangi</button>
      </div>

      <div class="hud">
        <div class="box">Waktu: <b><span id="hudTime">0.0</span></b> detik</div>
        <div class="box">Benar: <b><span id="hudScore">0</span></b> / <b>10</b></div>
        <div class="box">Pintu terbuka: <b><span id="hudDoors">0</span></b> / <b>10</b></div>
      </div>
    </div>

    <div class="gameArea">
      <canvas id="game" width="960" height="600" aria-label="Labirin"></canvas>

      <div class="panel">
        <h2>Cara main</h2>
        <ul>
          <li>HP: pakai tombol arah (↑ ↓ ← →) di kiri bawah.</li>
          <li>Laptop: panah / WASD.</li>
          <li>Sentuh/menabrak pintu (blok oranye) → muncul soal.</li>
          <li>Benar = pintu terbuka (hijau).</li>
          <li>Menuju kotak <b>FINISH</b> untuk selesai.</li>
        </ul>

        <div class="result">
          <div><b>Hasil</b></div>
          <div class="big" id="resultScore">-</div>
          <div class="small" id="resultTime">Waktu: -</div>
          <div class="small" id="resultNote">Hasil muncul setelah finish.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- D-Pad -->
  <div class="dpadHint">Tombol arah untuk gerak</div>
  <div class="dpadWrap" aria-label="Tombol arah">
    <div class="dpad">
      <div class="spacer"></div>
      <button class="dirBtn" id="btnUp"   type="button">↑</button>
      <div class="spacer"></div>

      <button class="dirBtn" id="btnLeft" type="button">←</button>
      <div class="spacer"></div>
      <button class="dirBtn" id="btnRight"type="button">→</button>

      <div class="spacer"></div>
      <button class="dirBtn" id="btnDown" type="button">↓</button>
      <div class="spacer"></div>
    </div>
  </div>

  <!-- Modal soal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 class="qTitle" id="qText">Soal</h2>
      <p class="qMeta" id="qMeta">Pilih jawaban.</p>
      <div class="choices" id="choices"></div>
      <div class="feedback" id="feedback"></div>
      <div class="footerBtns">
        <button id="btnCloseModal" class="secondary" disabled>Lanjut</button>
      </div>
    </div>
  </div>

  <script>
    /************* SOAL (10) *************/
    const QUESTIONS = [
      { id: 1, q: "Bangun datar yang memiliki dua pasang sisi sejajar dan sama panjang adalah …",
        choices: { A:"Trapesium", B:"Layang-layang", C:"Jajar genjang", D:"Belah ketupat" }, answer:"C" },

      { id: 2, q: "Perhatikan pernyataan berikut:\\n“Bangun datar ini memiliki empat sisi sama panjang dan diagonalnya saling tegak lurus.”\\nBangun datar yang dimaksud adalah …",
        choices: { A:"Persegi panjang", B:"Jajar genjang", C:"Belah ketupat", D:"Trapesium" }, answer:"C" },

      { id: 3, q: "Sebuah lapangan berbentuk persegi panjang memiliki panjang 20 m dan lebar 15 m.\\nLuas lapangan tersebut adalah …",
        choices: { A:"150 m²", B:"300 m²", C:"350 m²", D:"600 m²" }, answer:"B" },

      { id: 4, q: "Sebuah taman berbentuk trapesium memiliki sisi sejajar masing-masing 14 m dan 10 m serta tinggi 6 m.\\nLangkah yang tepat untuk menentukan luas taman tersebut adalah …",
        choices: { A:"Menjumlahkan semua sisi lalu dibagi 2", B:"Mengalikan kedua sisi sejajar", C:"Menjumlahkan sisi sejajar, dikalikan tinggi, lalu dibagi 2", D:"Mengalikan sisi sejajar terpanjang dengan tinggi" }, answer:"C" },

      { id: 5, q: "Ana menghitung luas belah ketupat dengan diagonal 12 cm dan 16 cm sebagai berikut:\\nL = 12 × 16 = 192 cm²\\nKesalahan Ana terletak pada …",
        choices: { A:"Salah memilih rumus", B:"Tidak membagi hasil perkalian dengan 2", C:"Salah mengukur diagonal", D:"Salah menentukan satuan" }, answer:"B" },

      { id: 6, q: "Sebuah taman sekolah akan dibuat berbentuk persegi dengan luas 64 m².\\nPanjang sisi taman yang tepat agar sesuai dengan rencana tersebut adalah …",
        choices: { A:"6 m", B:"7 m", C:"8 m", D:"9 m" }, answer:"C" },

      { id: 7, q: "Sebuah kolam ikan dirancang berbentuk trapesium dengan luas 72 m² dan tinggi 8 m.\\nJumlah panjang dua sisi sejajar kolam tersebut adalah …",
        choices: { A:"12 m", B:"18 m", C:"24 m", D:"30 m" }, answer:"B" },

      { id: 8, q: "Sebuah hiasan dinding berbentuk layang-layang dirancang memiliki luas 120 cm².\\nJika salah satu diagonalnya 20 cm, maka panjang diagonal lainnya yang sesuai adalah …",
        choices: { A:"8 cm", B:"12 cm", C:"16 cm", D:"20 cm" }, answer:"B" },

      { id: 9, q: "Sebuah papan reklame berbentuk jajar genjang direncanakan memiliki luas 150 m².\\nJika tinggi papan 10 m, maka panjang alas papan reklame yang mungkin adalah …",
        choices: { A:"10 m", B:"12 m", C:"15 m", D:"20 m" }, answer:"C" },

      { id: 10, q: "Sebuah meja belajar berbentuk persegi dengan keliling 96 cm.\\nPanjang sisi meja tersebut adalah …",
        choices: { A:"20 cm", B:"22 cm", C:"24 cm", D:"26 cm" }, answer:"C" }
    ];

    /************* MAZE *************/
    const GRID_W = 24;
    const GRID_H = 15;

    const maze = [
      "111111111111111111111111",
      "100000000001000000000001",
      "101111111101011111111101",
      "101000001001010000001001",
      "101011101111010111101101",
      "101010100000010100001001",
      "101010111111110111111101",
      "101010000000000000000001",
      "101011111111111111111101",
      "101000000000100000000001",
      "101111111110101111111101",
      "100000000010100000000001",
      "111111111010111111111101",
      "100000000000000000000001",
      "111111111111111111111111"
    ].map(row => row.split("").map(c => c === "1" ? 1 : 0));

    const START = { x: 1, y: 1 };
    const FINISH = { x: 22, y: 13 };

    const doors = [
      { id:0, x: 6,  y: 1,  open:false },
      { id:1, x: 10, y: 3,  open:false },
      { id:2, x: 3,  y: 5,  open:false },
      { id:3, x: 8,  y: 7,  open:false },
      { id:4, x: 12, y: 9,  open:false },
      { id:5, x: 16, y: 11, open:false },
      { id:6, x: 20, y: 9,  open:false },
      { id:7, x: 18, y: 7,  open:false },
      { id:8, x: 14, y: 5,  open:false },
      { id:9, x: 21, y: 13, open:false }
    ];
    for (const d of doors) maze[d.y][d.x] = 0;

    /************* CANVAS *************/
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    // UI
    const elName = document.getElementById("playerName");
    const btnStart = document.getElementById("btnStart");
    const btnReset = document.getElementById("btnReset");
    const hudTime = document.getElementById("hudTime");
    const hudScore = document.getElementById("hudScore");
    const hudDoors = document.getElementById("hudDoors");
    const resultScore = document.getElementById("resultScore");
    const resultTime = document.getElementById("resultTime");
    const resultNote = document.getElementById("resultNote");

    // Modal
    const modalOverlay = document.getElementById("modalOverlay");
    const qText = document.getElementById("qText");
    const qMeta = document.getElementById("qMeta");
    const choicesWrap = document.getElementById("choices");
    const feedback = document.getElementById("feedback");
    const btnCloseModal = document.getElementById("btnCloseModal");

    // D-Pad buttons
    const btnUp = document.getElementById("btnUp");
    const btnDown = document.getElementById("btnDown");
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");

    // State game
    let running = false;
    let startTimeMs = 0;
    let timerHandle = null;
    let scoreCorrect = 0;

    // Player
    let player = { x: 0, y: 0, r: 10 };
    let vel = { x: 0, y: 0 };
    const SPEED = 140;

    // Input
    const key = { up:false, down:false, left:false, right:false };

    // Doors / modal
    let activeDoor = null;
    let answeredDoor = new Set(); // pintu yang sudah benar (dibuka)

    // ✅ FIX: pintu yang "ditabrak" saat collision
    let pendingDoor = null;

    /************* BACKSOUND CERIA *************/
    let audioCtx = null;
    let musicTimer = null;
    let musicOn = false;

    function startMusic() {
      if (musicOn) return;
      musicOn = true;

      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume();

      const tempo = 132;
      const beatMs = 60000 / tempo;
      const scale = [0, 2, 4, 7, 9];
      const root = 60; // C4
      let step = 0;

      function midiToHz(m){ return 440 * Math.pow(2, (m-69)/12); }

      function ping(note, durMs, type="sine", gain=0.05) {
        const t0 = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = midiToHz(note);

        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + durMs/1000);

        osc.connect(g);
        g.connect(audioCtx.destination);

        osc.start(t0);
        osc.stop(t0 + durMs/1000 + 0.02);
      }

      function tick() {
        const pos = step % 8;
        if (pos === 0 || pos === 4) ping(36, 120, "triangle", 0.08);
        if (pos === 2 || pos === 6) ping(root + 12 + 7, 120, "sine", 0.03);

        const melody = root + 12 + scale[(step + 1) % scale.length];
        ping(melody, 160, "square", 0.018);

        step++;
      }

      tick();
      musicTimer = setInterval(tick, beatMs/2);
    }

    function stopMusic() {
      musicOn = false;
      if (musicTimer) clearInterval(musicTimer);
      musicTimer = null;
    }

    function cellSize() {
      return Math.floor(Math.min(canvas.width / GRID_W, canvas.height / GRID_H));
    }

    function resetGame() {
      running = false;
      if (timerHandle) clearInterval(timerHandle);
      timerHandle = null;

      stopMusic();

      for (const d of doors) d.open = false;
      answeredDoor = new Set();
      pendingDoor = null;

      const s = cellSize();
      player.x = (START.x + 0.5) * s;
      player.y = (START.y + 0.5) * s;
      vel.x = vel.y = 0;

      scoreCorrect = 0;
      hudScore.textContent = "0";
      hudDoors.textContent = "0";
      hudTime.textContent = "0.0";

      resultScore.textContent = "-";
      resultTime.textContent = "Waktu: -";
      resultNote.textContent = "Hasil muncul setelah finish.";

      btnStart.disabled = false;
      btnReset.disabled = true;

      draw();
    }

    function startGame() {
      const name = elName.value.trim();
      if (!name) { alert("Tulis nama dulu ya!"); elName.focus(); return; }

      resetGame();
      startMusic();

      running = true;
      btnStart.disabled = true;
      btnReset.disabled = false;

      startTimeMs = performance.now();
      timerHandle = setInterval(() => {
        if (!running) return;
        const t = (performance.now() - startTimeMs) / 1000;
        hudTime.textContent = t.toFixed(1);
      }, 100);

      requestAnimationFrame(loop);
    }

    function openQuestionForDoor(door) {
      activeDoor = door;
      const q = QUESTIONS[door.id];

      modalOverlay.style.display = "flex";
      qText.textContent = q.q;
      qMeta.textContent = `Pintu ${door.id + 1} dari 10. Pilih A, B, C, atau D.`;

      feedback.style.display = "none";
      feedback.className = "feedback";
      feedback.textContent = "";

      btnCloseModal.disabled = true;
      choicesWrap.innerHTML = "";

      ["A","B","C","D"].forEach(k => {
        const b = document.createElement("button");
        b.className = "choiceBtn";
        b.textContent = `${k}. ${q.choices[k]}`;
        b.onclick = () => handleAnswer(door, k);
        choicesWrap.appendChild(b);
      });
    }

    function handleAnswer(door, selected) {
      [...choicesWrap.querySelectorAll("button")].forEach(b => b.disabled = true);

      const q = QUESTIONS[door.id];
      const benar = selected === q.answer;

      feedback.style.display = "block";
      if (benar) {
        door.open = true;
        answeredDoor.add(door.id);
        scoreCorrect++;
        hudScore.textContent = String(scoreCorrect);
        hudDoors.textContent = String(doors.filter(d => d.open).length);
        feedback.classList.add("ok");
        feedback.innerHTML = `✅ <strong>Benar!</strong> Pintunya terbuka.`;
      } else {
        feedback.classList.add("bad");
        feedback.innerHTML = `❌ <strong>Salah.</strong> Pintu masih terkunci. Jawaban benar: <strong>${q.answer}</strong>.`;
      }

      btnCloseModal.disabled = false;
      btnCloseModal.onclick = () => {
        modalOverlay.style.display = "none";
        activeDoor = null;
      };
    }

    function finishIfReached() {
      const s = cellSize();
      const cx = Math.floor(player.x / s);
      const cy = Math.floor(player.y / s);
      if (cx === FINISH.x && cy === FINISH.y) {
        running = false;
        if (timerHandle) clearInterval(timerHandle);
        timerHandle = null;

        stopMusic();

        const t = (performance.now() - startTimeMs) / 1000;
        resultScore.textContent = `${scoreCorrect}/10`;
        resultTime.textContent = `Waktu: ${t.toFixed(1)} detik`;
        resultNote.textContent = "Selesai! Kamu bisa klik Ulangi untuk main lagi.";

        btnStart.disabled = false;
        btnReset.disabled = false;
      }
    }

    function isWallCell(x, y) {
      if (x < 0 || y < 0 || x >= GRID_W || y >= GRID_H) return true;
      return maze[y][x] === 1;
    }

    function doorAtCell(x, y) {
      return doors.find(d => d.x === x && d.y === y) || null;
    }

    // ✅ kembalikan OBJECT door kalau terkunci, null kalau tidak
    function blockedByDoorCell(x, y) {
      const d = doorAtCell(x, y);
      if (!d) return null;
      return d.open ? null : d;
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function movePlayer(dt) {
      // reset "pintu yang ditabrak" di frame ini
      pendingDoor = null;

      let ix = (key.right ? 1 : 0) - (key.left ? 1 : 0);
      let iy = (key.down ? 1 : 0) - (key.up ? 1 : 0);

      const len = Math.hypot(ix, iy);
      if (len > 0) { ix /= len; iy /= len; }

      vel.x = ix * SPEED;
      vel.y = iy * SPEED;

      const s = cellSize();
      const nx = player.x + vel.x * dt;
      const ny = player.y + vel.y * dt;
      const r = player.r;

      // move X
      let tx = nx;
      if (!collides(tx, player.y, r, s)) player.x = tx;

      // move Y
      let ty = ny;
      if (!collides(player.x, ty, r, s)) player.y = ty;

      // ✅ buka soal saat collision dengan pintu terkunci
      if (running && modalOverlay.style.display !== "flex" && pendingDoor) {
        // hindari kebuka kalau pintu sudah kebuka karena jawaban benar
        if (!pendingDoor.open && !answeredDoor.has(pendingDoor.id)) {
          openQuestionForDoor(pendingDoor);
        }
        pendingDoor = null;
      }

      finishIfReached();
    }

    function collides(px, py, r, s) {
      const minX = Math.floor((px - r) / s);
      const maxX = Math.floor((px + r) / s);
      const minY = Math.floor((py - r) / s);
      const maxY = Math.floor((py + r) / s);

      for (let y = minY; y <= maxY; y++) {
        for (let x = minX; x <= maxX; x++) {
          const wall = isWallCell(x, y);
          const lockedDoorObj = blockedByDoorCell(x, y);

          if (!wall && !lockedDoorObj) continue;

          const rx = x * s, ry = y * s, rw = s, rh = s;
          const cx = clamp(px, rx, rx + rw);
          const cy = clamp(py, ry, ry + rh);
          const dx = px - cx, dy = py - cy;

          if ((dx*dx + dy*dy) < (r*r)) {
            // simpan pintu yang ditabrak (kalau ada)
            if (lockedDoorObj) pendingDoor = lockedDoorObj;
            return true;
          }
        }
      }
      return false;
    }

    function draw() {
      const s = cellSize();
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      for (let y=0; y<GRID_H; y++){
        for (let x=0; x<GRID_W; x++){
          if (maze[y][x] === 1) {
            ctx.fillStyle = "#0f172a";
            ctx.fillRect(x*s, y*s, s, s);
          } else {
            ctx.fillStyle = "#f1f5f9";
            ctx.fillRect(x*s, y*s, s, s);
          }
        }
      }

      for (const d of doors) {
        const px = d.x*s, py = d.y*s;
        if (d.open) {
          ctx.fillStyle = "#22c55e";
          ctx.fillRect(px, py, s, s);
          ctx.fillStyle = "#ffffff";
          ctx.font = "bold 12px sans-serif";
          ctx.fillText("OK", px+6, py+s-6);
        } else {
          ctx.fillStyle = "#f59e0b";
          ctx.fillRect(px, py, s, s);
          ctx.fillStyle = "#0f172a";
          ctx.font = "bold 12px sans-serif";
          ctx.fillText(String(d.id+1), px+6, py+s-6);
        }
      }

      ctx.fillStyle = "#2563eb";
      ctx.fillRect(START.x*s, START.y*s, s, s);
      ctx.fillStyle = "#fff";
      ctx.font = "bold 12px sans-serif";
      ctx.fillText("S", START.x*s+6, START.y*s+s-6);

      ctx.fillStyle = "#7c3aed";
      ctx.fillRect(FINISH.x*s, FINISH.y*s, s, s);
      ctx.fillStyle = "#fff";
      ctx.font = "bold 12px sans-serif";
      ctx.fillText("FINISH", FINISH.x*s+3, FINISH.y*s+s-6);

      ctx.beginPath();
      ctx.fillStyle = "#2563eb";
      ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
      ctx.fill();

      ctx.lineWidth = 2;
      ctx.strokeStyle = "#0f172a";
      ctx.stroke();
    }

    let lastTs = 0;
    function loop(ts) {
      if (!running) { draw(); return; }

      const dt = Math.min(0.033, (ts - lastTs) / 1000 || 0);
      lastTs = ts;

      // stop movement when modal open
      if (modalOverlay.style.display !== "flex") {
        movePlayer(dt);
      }

      draw();
      requestAnimationFrame(loop);
    }

    /************* KEYBOARD *************/
    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if (e.key === "ArrowUp" || k === "w") key.up = true;
      if (e.key === "ArrowDown" || k === "s") key.down = true;
      if (e.key === "ArrowLeft" || k === "a") key.left = true;
      if (e.key === "ArrowRight" || k === "d") key.right = true;
    });
    window.addEventListener("keyup", (e) => {
      const k = e.key.toLowerCase();
      if (e.key === "ArrowUp" || k === "w") key.up = false;
      if (e.key === "ArrowDown" || k === "s") key.down = false;
      if (e.key === "ArrowLeft" || k === "a") key.left = false;
      if (e.key === "ArrowRight" || k === "d") key.right = false;
    });

    /************* D-PAD *************/
    function bindDir(btn, dirKey) {
      const down = (ev) => {
        ev.preventDefault();
        key[dirKey] = true;
        btn.classList.add("active");
      };
      const up = (ev) => {
        ev.preventDefault();
        key[dirKey] = false;
        btn.classList.remove("active");
      };

      btn.addEventListener("pointerdown", down);
      btn.addEventListener("pointerup", up);
      btn.addEventListener("pointercancel", up);
      btn.addEventListener("pointerleave", up);
    }
    bindDir(btnUp, "up");
    bindDir(btnDown, "down");
    bindDir(btnLeft, "left");
    bindDir(btnRight, "right");

    /************* BUTTONS *************/
    btnStart.addEventListener("click", startGame);
    btnReset.addEventListener("click", resetGame);

    // init
    resetGame();
  </script>
</body>
</html>
